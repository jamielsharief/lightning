name: CI
on:
  push:
  schedule:
    - cron: '0 0 * * *'
env:
  DB_URL: "mysql:host=127.0.0.1;port=3306;dbname=lightning"
  DB_DATABASE: lightning
  DB_USERNAME: root
  DB_PASSWORD: root
  REDIS_HOST: '127.0.0.1'
  REDIS_PORT: 6379
jobs:
  tests:
    name: "PHP ${{ matrix.php-version }}"
    runs-on: "ubuntu-20.04"
    strategy:
      matrix:
        php-version:
          - "7.4"
          - "8.0"
          - "8.1"
    steps:
      - name: MySQL Server
        run: |
          sudo /etc/init.d/mysql start
          mysql -e 'CREATE DATABASE lightning;' -uroot -proot
          mysql -e 'SHOW DATABASES;' -uroot -proot
      - name: Setup Redis
        run: docker run -p 6379:6379 -d redis
      - name: Checkout source code
        uses: "actions/checkout@v2"
      - name: Install PHP
        uses: "shivammathur/setup-php@v2"
        with:
          coverage: "xdebug"
          php-version: "${{ matrix.php-version }}"
          extensions: pdo_mysql, pdo_sqlite, pdo_pgsql, mailparse, imap, redis, ssh2
          ini-values: apc.enable=1, apc.enable_cli=1
      - name: Install dependencies
        run: |
          composer require --dev php-coveralls/php-coveralls
          composer update --no-progress --prefer-dist
      - name: Setup
        run: |
          sudo mysql -uroot -proot -h 127.0.0.1 lightning < database/schema/schema.sql
          touch .env
          sudo locale-gen es_ES.UTF-8 nl_NL.UTF-8
          mkdir -p build/logs
      - name: Run PHPUnit
        run: "php vendor/bin/phpunit --coverage-clover build/logs/clover.xml"
      - name: Coveralls
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: "php vendor/bin/php-coveralls --verbose"
      - name: Run PHPStan
        run: "vendor/bin/phpstan analyse src --error-format=github"